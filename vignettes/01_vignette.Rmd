---
title: "01_vignette"
author: "Beniamino Sartini"
date: "2023-01-19"
output: html_document
---

```{r setup, include=FALSE}
# general setup 
knitr::opts_chunk$set(message=FALSE, echo = TRUE,  warning = FALSE, fig.align = "center", fig.pos = "H")

library(knitr)      # knit for `kable()`
library(rmdformats) # formattazione markdown
library(kableExtra) # create clean tables for pdf outputs 


setwd("/Users/macbook/Documents/R_packages/cryptocompareR_0_1_0")


# Utility Functions
source("R/as_unix.R")

# Api Function
source("R/cryptocompare_api.R")

# General Informations
source("R/cc_market_info.R")

# Historical Data 
source("R/cc_blockchain_historical.R")
source("R/cc_exchange_historical.R")
source("R/cc_price_historical.R")

# Live Price 
source("R/cc_symbol_price.R")

source("R/moving_averages.R")

api_key = "153bc970c37d2a4d8e6735f89d5602b7787f9765e0add94ad960ff91b0326813"

```


```{r}

# Sample Dataset 
df_pair_D = cc_price_historical(symbol = "BTC", start = "2019-01-01", end = NULL,  exchange = NULL, currency = "USD", interval = "daily", api_key = NULL) 
df_pair_H = cc_price_historical(symbol = "BTC", start = "2019-01-01", end = NULL,  exchange = NULL, currency = "USD", interval = "hourly", api_key = NULL) 

```

# Exponential Moving Averages

Taking in consideration a $N$ observation with interval of times: $t \in [t_1, t_2, ..., t_N]$, it is possible to compute the **exponential moving averages** of order **n** as: 

$$EMA(t, n) = (1-\gamma) \cdot EMA(t-1, n) + \gamma \cdot EMA(t, n)$$
- where $\gamma$ is a smoothing factor usually set equal to 2. 

Starting from $t = 1$ and considering an EMA of order **n**, the first (n-1) values of the EMAs will be not computable, while the firt value at time $t_n$ will be computed as a simple moving 
average of order n:

$$SMA(t, n) = \frac{1}{n} \sum_{i = 1}^{n} x_{t-i}$$


# Probability of Green/Red Candles

One of the first question that we could ask ourselves when considering OHLCV data is: **The probability of having the next candle green is more or less equal to having the next candle red?**.
In order to ask to our question we could simply compute the historical frequency of green a red candles. 

```{r}

bind_rows(
  tibble(
  Pair = paste0(df_pair_D$Symbol[1], "-", df_pair_D$Currency[1]),
  TimeFrame = "Day", 
  Prob.Green = mean(df_pair_D$OC > 0), 
  Mu.HL.Green = mean(filter(df_pair_D, OC > 0)$HL*100),
  Sd.HL.Green = sd(filter(df_pair_D, OC > 0)$HL*100),
  Prob.Red = mean(df_pair_D$OC < 0),
  Mu.HL.Red = mean(filter(df_pair_D, OC < 0)$HL*100),
  Sd.HL.Red = sd(filter(df_pair_D, OC < 0)$HL*100),
), 
tibble(
  Pair = paste0(df_pair_H$Symbol[1], "-", df_pair_H$Currency[1]),
  TimeFrame = "Hourly", 
  Prob.Green = mean(df_pair_H$OC > 0), 
  Mu.HL.Green = mean(filter(df_pair_H, OC > 0)$HL*100),
  Sd.HL.Green = sd(filter(df_pair_H, OC > 0)$HL*100),
  Prob.Red = mean(df_pair_H$OC < 0),
  Mu.HL.Red = mean(filter(df_pair_H, OC < 0)$HL*100),
  Sd.HL.Red = sd(filter(df_pair_H, OC < 0)$HL*100)
)
)%>%
  mutate_if(is.numeric, round, 3) %>%
  kable() %>%
  kable_classic()
```
The variables computed represents: 

- **Prob.Green**: the bistorical probability of having a green candle
- **Mu.HL.Green**: the bistorical mean of the High-Low range when the candle is green. 
- **Sd.HL.Green**: the bistorical standard deviation of the High-Low range when the candle is green. 

- **Prob.Red**: the bistorical probability of having a red candle.
- **Mu.HL.Red**: the bistorical mean of the High-Low range when the candle is red. 
- **Sd.HL.Red**: the bistorical standard deviation of the High-Low range when the candle is red. 

Considering the **BTC-USD** pair we can see that the probability of having a Green or Red candle is 50%/50% considering the hourly timeframe. Instead on the daily timeframe we have a probability of having a **green candle** greater than 50%. 

If we consider the standard deviations of the High-Low range, we have that in the case of a green candle the mean return Low to High is 5.2% instead when the candle is red 5.6%. Also the **Sd.HL** variables, that represents the standard deviations of the returns is higher with red candle. This means that when there is a move down the amplitude of the candle is greater with respect to a movement up and it is also more volatile. 


## Looking at the Moving Averages gives a Statistical Advantage? 

In order to ask to this question we will use 4 EMAs with different lenghts: 5, 10, 60, 223. 


### Question 1: If the EMA 60 is ABOVE the EMA 223 what is the probability of having the next candle Green?

```{r}
df1 <- df_pair_H %>%
  add_EMA(variable = "Close", n = 60, na.rm = TRUE, smooth = 2)%>%
  add_EMA(variable = "Close", n = 223, na.rm = TRUE, smooth = 2) %>%
  na.omit() %>%
  mutate(condition = ifelse(EMA_Close_60 >= EMA_Close_223,"EMA 60 is ABOVE EMA 223 (Hourly)", "EMA 60 is BELOW EMA 223 (Hourly)"),
         probability = ifelse(OC > 0, 1,0))  %>%
  group_by(condition) %>%
  summarise(Green.Candle = mean(probability), probability = n())

df2 <- df_pair_D %>%
  add_EMA(variable = "Close", n = 60, na.rm = TRUE, smooth = 2)%>%
  add_EMA(variable = "Close", n = 223, na.rm = TRUE, smooth = 2) %>%
  na.omit() %>%
  mutate(condition = ifelse(EMA_Close_60 >= EMA_Close_223,"EMA 60 is ABOVE EMA 223 (Daily)", "EMA 60 is BELOW EMA 223 (Daily)"),
         probability = ifelse(OC > 0, 1,0))  %>%
  group_by(condition) %>%
  summarise(Green.Candle = mean(probability), probability = n())


bind_rows(df1[1,], df2[1,])%>%
  mutate(probability = probability/sum(df1$probability)) %>%
  mutate_if(is.double, round, 4) %>%
  kable() %>%
  kable_classic()

```
### Question 1: If the EMA 60 is CROSS the EMA 223 what is the probability of having the next candle Green?

```{r}

df1 <- df_pair_H %>%
  add_EMA(variable = "Close", n = 60, na.rm = TRUE, smooth = 2)%>%
  add_EMA(variable = "Close", n = 223, na.rm = TRUE, smooth = 2) %>%
  na.omit() %>%
  mutate(condition = ifelse(EMA_Close_60 > EMA_Close_223 & lag(EMA_Close_60) <= lag(EMA_Close_223), "EMA 60 is CROSS EMA 223 (Hourly)", "No Signal (Hourly)"),
         probability = ifelse(OC > 0, 1, 0))  %>%
  group_by(condition) %>%
  summarise(Green.Candle = mean(probability), probability = n()) %>%
  na.omit()

df2 <- df_pair_D %>%
  add_EMA(variable = "Close", n = 60, na.rm = TRUE, smooth = 2)%>%
  add_EMA(variable = "Close", n = 223, na.rm = TRUE, smooth = 2) %>%
  na.omit() %>%
  mutate(condition = ifelse(EMA_Close_60 > EMA_Close_223 & lag(EMA_Close_60) <= lag(EMA_Close_223), "EMA 60 is CROSS EMA 223 (Daily)", "No Signal (Daily)"),
         probability = ifelse(OC > 0, 1, 0))  %>%
  group_by(condition) %>%
  summarise(Green.Candle = mean(probability), probability = n()) %>%
  na.omit()

bind_rows(df1[1,], df2[1,]) %>%
  mutate(probability = probability/sum(df1$probability)) %>%
  mutate_if(is.double, round, 4) %>%
  kable() %>%
  kable_classic()

```
### Question 2: If the EMA 5 CROSS the EMA 10 what is the probability of having the next candle Green?

```{r}
df1 <- df_pair_H %>%
  add_EMA(variable = "Close", n = 5, na.rm = TRUE, smooth = 2)%>%
  add_EMA(variable = "Close", n = 10, na.rm = TRUE, smooth = 2) %>%
  na.omit() %>%
  mutate(condition = ifelse(EMA_Close_5 > EMA_Close_10 & lag(EMA_Close_5) <= lag(EMA_Close_10), "EMA 5 CROSS EMA 10 (Hourly)", "No Signal (Hourly)"),
         probability = ifelse(OC > 0, 1, 0))  %>%
  group_by(condition) %>%
  summarise(Green.Candle = mean(probability), probability = n()) %>%
  na.omit()

df2 <- df_pair_D %>%
  add_EMA(variable = "Close", n = 5, na.rm = TRUE, smooth = 2)%>%
  add_EMA(variable = "Close", n = 10, na.rm = TRUE, smooth = 2) %>%
  na.omit() %>%
  mutate(condition = ifelse(EMA_Close_5 > EMA_Close_10 & lag(EMA_Close_5) <= lag(EMA_Close_10), "EMA 5 CROSS EMA 10 (Daily)", "No Signal (Daily)"),
         probability = ifelse(OC > 0, 1, 0))  %>%
  group_by(condition) %>%
  summarise(Green.Candle = mean(probability), probability = n()) %>%
  na.omit()

bind_rows(df1[1,], df2[1,]) %>%
  mutate(probability = probability/sum(df1$probability)) %>%
  mutate_if(is.double, round, 4) %>%
  kable() %>%
  kable_classic()

```



